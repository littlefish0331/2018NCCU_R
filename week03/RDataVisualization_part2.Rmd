---
title: "EDA with R"
author: "Pei-Rou,Lin"
date: "2018.12.3"
output:
  ioslides_presentation:
    code_folding: hide
    css: css/dsp_1.css
    self_contained: no
    widescreen: yes
  slidy_presentation: default
subtitle: Data Visualization with plotly & highcharter
---

<!--
教學檔在bitbucket:
https://bitbucket.org/yeyuting/2018nccu_r/src/master/week03/
-->

```{r ,echo=FALSE,warning=FALSE,message=F}
setwd('C:/Users/ASUS/Documents/2018nccu_r/week03/')
options('scipen'=100,'digits'=2)
knitr::opts_chunk$set(comment="",prompt=F,strip.white=F,
                      warning=FALSE,message=F,echo=T,
                      fig.align='center',fig.height=3.5)
##----載入套件----
library(dplyr)
library(dygraphs)
library(ggplot2)
library(ggmap)
library(data.table)
library(devtools)
library(plotly)
library(xtable)
library(tidyr)
library(DT)
library(RColorBrewer)
library(dtplyr)
library(knitr)
library(kableExtra)
library(highcharter)
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
transaction<-read.csv("./data/transaction.csv")
titanic<-read.csv("./data/train.csv")
```


```{r, include=FALSE,echo = FALSE}
# 先轉成長資料
count_city <- transaction %>% group_by(city) %>% summarise(n= n()) %>% as.data.frame()
```

```{r include=FALSE,eval=F,echo=TRUE, fig.align='center', fig.height=3.5, fig.width=7, message=FALSE, warning=FALSE, paged.print=FALSE}
# ---- 方法二----
# 先轉成長資料
count_city <- transaction %>% group_by(city) %>% summarise(n= n()) %>% as.data.frame()

```


```{r include=FALSE,echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
count_class <- titanic %>% 
  filter(Survived=="1") %>% 
  # 抓出生存者
  group_by(Pclass) %>%
  # 以艙等分組
  summarise(n= n()) %>% 
  # 以分組計算各別數量
  as.data.frame()
```




```{r include=FALSE,message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
count_city_use <- 
  transaction %>% group_by(city,use_type) %>% summarise(n_1= n()) %>% as.data.frame()
count_city_use <- 
  merge(count_city_use,count_city,all.x = T) %>% 
  mutate(rate = round((n_1/n),3)) %>% 
  arrange(city,-rate)
```




    
```{r include=FALSE,echo=T,message=FALSE, warning=FALSE, paged.print=FALSE}
count_city_use <- 
  transaction %>% group_by(city,use_type) %>% summarise(n_use= n()) %>% as.data.frame()
count_city_use <- 
  merge(count_city_use,count_city,all.x = T) %>% 
  mutate(rate = round((n_use/n),3)) %>% 
  arrange(city,-rate)
```






```{r include=FALSE,echo=TRUE}
table<- titanic %>% 
  group_by(Pclass,Survived) %>% 
  summarise(n=n()) %>% 
  as.data.frame()
```



```{r include=FALSE,echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
transaction$trac_month <- 
  factor(transaction$trac_month)

count_month_taipei <- 
  transaction %>% 
  filter(city == "臺北市" ) %>% 
  group_by(trac_month) %>% 
  summarise(n = n()) %>% 
  as.data.frame()
```




```{r include=FALSE,echo=TRUE}
count_month <- transaction %>% group_by(city,trac_month) %>% summarise(n = n()) %>% as.data.frame()
```


# plotly

## plotly 簡介
- Plotly是一個資料視覺化的R套件，以簡單的方式，讓資料能夠產生互動的效果。
- 提供一個合作平台，使用者能夠將自己在R中繪製的圖存上屬於自己的Plotly平台上。
- 結合了各式各樣的API，包裝`Python`、`R`、`Matlab`、...等等

>- 當然~ggplot2也能夠輕易地使用plotly轉換成互動式的圖表!!

## 想知道更多~

- [Plotly 官網](https://plot.ly/)
- [Plotly for R  - 推薦](https://plotly-book.cpsievert.me/index.html)
- [plotly.R Library - 推薦](https://plot.ly/r/#fundamentals)
- [plotly cheat sheet](https://images.plot.ly/plotly-documentation/images/r_cheat_sheet.pdf)

<!--
## 基本架構
```{r eval=F}
data %>% 
  plot_ly( x = ~x, y = ~y, frame = ~f, size = ~s, text = ~t, color = ~c, type = "scatter" "bar" "histogram" "heatmap" "box", mode = "markers" "line" )

```
-->

## 畫圖前的準備

- 安裝套件
```{r eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
install.packages(c("plotly"))
```
<!--install.packages(c("ggplot2","dplyr","tidyverse")),repos="http://cran.csie.ntu.edu.tw/")-->
</br>

- 載入套件
```{r eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(plotly)
```
</br>

## 基本架構

- `plot_ly()`

- 注意:
    
    - 以**`%>%`**連接
    
    - 指定變數前須加**`~`** 


## `ggplotly()`

- ggplot可以使用plotly換成互動式的圖表

```{r echo=TRUE,eval=F}
temp ##ggplot的圖 
ggplotly(temp)
```


## histogram - `ggplotly`

- ex : **交易房屋的屋齡狀況**

```{r echo=TRUE, fig.align='center', fig.height=3.3, fig.width=6.5}
temp<-transaction %>% ggplot(aes(x=age, y =..count..)) + 
  geom_histogram(colour="grey",fill = "steelblue",binwidth = 5)+
  labs(title="交易房屋的屋齡狀況",x="屋齡",y="數量")
ggplotly(temp)
```

## histogram - `plot_ly`

- ex : **交易房屋的屋齡狀況**

```{r echo=TRUE, fig.align='center', fig.height=3.5, fig.width=6.5}
transaction %>% plot_ly(x = ~age, type = "histogram")
```

## boxplot - `ggplotly`

- ex:**呈現各縣市每平方公尺價格**

```{r echo=TRUE, fig.align='center', fig.height=3.3, fig.width=6.5}
temp<-transaction %>% ggplot(aes(x=city,y=price_unit)) + 
  geom_boxplot() + 
  labs(title="各縣市每平方公尺價格",x = "縣市" , y = "每平方公尺價格(元)")
ggplotly(temp)
```

## boxplot - `plot_ly`

- ex:**呈現各縣市每平方公尺價格**

```{r echo=TRUE, fig.align='center', fig.height=3.3, fig.width=6.5}
transaction %>% plot_ly(x = ~price_unit, y = ~use_type) %>% 
  add_boxplot(color = ~use_type) %>%
  layout(yaxis = list(title = ""), margin = list(l = 100))
```

## boxplot - `plot_ly`

- ex:**呈現各縣市各使用分區每平方公尺價格**

- `y = ~interaction(use_type,city)`

```{r, echo=TRUE,fig.align='center', fig.height=3.3, fig.width=6.5}
transaction %>% plot_ly(x = ~price_unit, y = ~interaction(use_type,city)) %>% 
  add_boxplot(color = ~use_type) %>%
  layout(yaxis = list(title = ""), margin = list(l = 100))
```


## scatter plot - `ggplotly`

- **ex : iris花瓣長度(Petal.Length)和花萼長度(Sepal.Length)關係**

```{r echo=TRUE, fig.align='center', fig.height=3.3, fig.width=6.5}
temp<-ggplot(iris , aes(x=Sepal.Length, y=Petal.Length, color=Species)) + 
  geom_point(shape=1, size=2)+# shape控制圖示；size控制點的大小
  labs(title="花萼和花瓣長度",x="花萼長度",y="花瓣長度")
ggplotly(temp)
```

<!--
```{r}
transaction[which(transaction$city =="臺北市"),] %>%  plot_ly (
  x = ~age ,
  y = ~price_unit ,
  color = ~use_type,
  type = 'scatter',
  mode = 'markers')

diamonds %>%  plot_ly (
  x = ~carat ,
  y = ~price ,
  color = ~color,
  type = 'scatter',
  mode = 'markers')
```

-->

## scatter plot - `plot_ly`

- **ex : iris花瓣長度(Petal.Length)和花萼長度(Sepal.Length)關係**

```{r echo=TRUE, fig.align='center', fig.height=3, fig.width=6}
iris %>% 
  plot_ly (
  x = ~Sepal.Length ,
  y = ~Petal.Length ,
  color = ~Species,
  type = 'scatter',
  mode = 'markers')
```

<!--
```{r echo=TRUE,eval=F}
diamonds %>%  plot_ly(
    x = ~carat ,
    y = ~price ,
    frame = ~cut,
    type = 'scatter',
    mode = 'markers'
  )
```
-->

# highcharter

## highcharter 簡介

- 使用`data.frame`
- 使用`wide format` (與ggplot相反!)
- [highcharter 官方網站](https://www.highcharts.com/)
- [更多關於highcharter -推薦](http://jkunst.com/highcharter/hchart.html)

## 畫圖前的準備

- 安裝套件
```{r eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
install.packages(c("highcharter"))
```
</br>

- 載入套件
```{r eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(highcharter)
```
</br>



## 基本語法

```{r eval=F}
highchart() %>% 
  hc_title(text = "...") %>% 
  hc_xAxis(categories = ...$...) %>% 
  hc_add_series(name = "...", data =...$...,color="...") %>% 
  hc_add_series(name = "...", data = ...$...,color="...")
```


注意 : 

- 使用<font color = "red">寬資料</font>

- 指定變數需放置`data$變數`

- 以**`%>%`**連接

## 折線圖

ex : 各縣市的各月份的交易量

檢視資料:

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
count_month_wide<-spread(count_month, key = city, value = n)
```

<div style="float: left; width: 50%;">
```{r echo=FALSE}
count_month
```
</div>
<div style="float: right; width: 50%;">
```{r echo=FALSE}
count_month_wide
```
</div>

## 

- ex : **呈現各縣市各月份的交易量**

```{r eval=F,echo=TRUE, fig.align='center', fig.height=3.3, fig.width=6.5}
highchart() %>% 
  hc_title(text = "各縣市的各月份的交易量") %>% 
  hc_xAxis(categories = count_month$trac_month) %>% #以month當x軸
  hc_add_series(name = "臺北市", data =count_month_wide$`臺北市`,color="#006BA6") %>% #第一條線
  hc_add_series(name = "新北市", data =count_month_wide$`新北市`,color="#FFBC42") %>% #第二條線
  hc_add_series(name = "高雄市", data =count_month_wide$`高雄市`,color="#D81159") %>% #第三條線
  hc_add_series(name = "臺中市", data =count_month_wide$`臺中市`,color="#8F2D56") #第四條線

```

## 

- ex : **呈現各縣市各月份的交易量**

```{r echo=F, fig.align='center', fig.height=3.3, fig.width=6.5}
highchart() %>% 
  hc_title(text = "各縣市的各月份的交易量") %>% 
  hc_xAxis(categories = count_month$trac_month) %>% #以month當x軸
  hc_add_series(name = "臺北市", data =count_month_wide$`臺北市`,color="#006BA6") %>% #第一條線
  hc_add_series(name = "新北市", data =count_month_wide$`新北市`,color="#FFBC42") %>% #第二條線
  hc_add_series(name = "高雄市", data =count_month_wide$`高雄市`,color="#D81159") %>% #第三條線
  hc_add_series(name = "臺中市", data =count_month_wide$`臺中市`,color="#8F2D56") #第四條線

```

## 長條圖 

- 加 `,type = "column"` : 圖形由折線圖改為長條圖

ex : **各縣市的各使用分區的交易量**

```{r echo=TRUE}
count_city_use_wide<-spread(data = count_city_use[,c(1:3)], key = use_type, value = n_use)
```

<div style="float: left; width: 50%;">
```{r echo=FALSE}
count_city_use
```
</div>
<div style="float: right; width: 50%;">
```{r echo=FALSE}
count_city_use_wide
```
</div>

##

ex : **各縣市的各使用分區的交易量**

```{r eval=F,echo=TRUE,message=FALSE, warning=FALSE, paged.print=FALSE}
highchart() %>% 
  hc_title(text = "各縣市的各使用分區的交易量") %>% 
  hc_xAxis(categories = factor(count_city_use_wide$city)) %>% #以city當x軸
  hc_add_series(name = "工", data =count_city_use_wide$`工`,color="#006BA6",type = "column") %>% #第一條線
  hc_add_series(name = "住", data =count_city_use_wide$`住`,color="#FFBC42",type = "column") %>% #第二條線
  hc_add_series(name = "其他", data =count_city_use_wide$`農`,color="#D81159",type = "column") %>% #第三條線
  hc_add_series(name = "商", data =count_city_use_wide$`商`,color="#8F2D56",type = "column") #第四條線
```

##

ex : **各縣市的各使用分區的交易量**

```{r echo=F,message=FALSE, warning=FALSE, paged.print=FALSE}
highchart() %>% 
  hc_title(text = "各縣市的各使用分區的交易量") %>% 
  hc_xAxis(categories = factor(count_city_use_wide$city)) %>% #以city當x軸
  hc_add_series(name = "工", data =count_city_use_wide$`工`,color="#006BA6",type = "column") %>% #第一條線
  hc_add_series(name = "住", data =count_city_use_wide$`住`,color="#FFBC42",type = "column") %>% #第二條線
  hc_add_series(name = "其他", data =count_city_use_wide$`農`,color="#D81159",type = "column") %>% #第三條線
  hc_add_series(name = "商", data =count_city_use_wide$`商`,color="#8F2D56",type = "column") #第四條線
```

## 顯示文字

- 加 `,dataLabels = list(enabled = T)` : 顯示數字
```{r eval=F,echo=TRUE,message=FALSE, warning=FALSE, paged.print=FALSE}
highchart() %>% 
  hc_title(text = "各縣市的各使用分區的交易量") %>% 
  hc_xAxis(categories = count_city_use_wide$city) %>% #以month當x軸
  hc_add_series(name = "工", data =count_city_use_wide$`工`,color="#006BA6",type = "column", dataLabels = list(enabled = T)) %>% #第一條線
  hc_add_series(name = "住", data =count_city_use_wide$`住`,color="#FFBC42",type = "column", dataLabels = list(enabled = T)) %>% #第二條線
  hc_add_series(name = "其他", data =count_city_use_wide$`農`,color="#D81159",type = "column", dataLabels = list(enabled = T)) %>% #第三條線
  hc_add_series(name = "商", data =count_city_use_wide$`商`,color="#8F2D56",type = "column", dataLabels = list(enabled = T)) #第四條線
```

## 

```{r echo=F,message=FALSE, warning=FALSE, paged.print=FALSE, fig.align='center', fig.height=3.3, fig.width=6.5}
highchart() %>% 
  hc_title(text = "各縣市的各使用分區的交易量") %>% 
  hc_xAxis(categories = count_city_use_wide$city) %>% #以month當x軸
  hc_add_series(name = "工", data =count_city_use_wide$`工`,color="#006BA6",type = "column", dataLabels = list(enabled = T)) %>% #第一條線
  hc_add_series(name = "住", data =count_city_use_wide$`住`,color="#FFBC42",type = "column", dataLabels = list(enabled = T)) %>% #第二條線
  hc_add_series(name = "其他", data =count_city_use_wide$`農`,color="#D81159",type = "column", dataLabels = list(enabled = T)) %>% #第三條線
  hc_add_series(name = "商", data =count_city_use_wide$`商`,color="#8F2D56",type = "column", dataLabels = list(enabled = T)) #第四條線
```


 

